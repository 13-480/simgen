-*- mode: outline; fill-column: 70; coding: utf-8 -*-

* 入力データの文法 (17 Apr 2021)
simgen04.rb からの文法

** 入力ファイルの基本事項
*** コメント
# で始まる行はコメント
空行は無視

*** 変数名、グループ名
すべての文字を使ってよいが、以下の文字と空白は使えない。
| -+=<>()#?:"'[]{},

先頭に数字は使えない。
グループ名はブレースで囲む。

変数名を要求される所ではどこでも、「変数名:{グループ名}」のように、グルー
プへの登録指定も行える。

*** 変数名集合
| グループ名
| [変数名orグループ名 ...]
ブラケットに入っている場合でもグループ名はブレースで囲む。

*** 1次式
| 数値 変数名 [+-] 数値 変数名 ...
定数項も可。
変数名の所では、「{グループ名}.sum」や、「変数名集合.sum」も可能。

TODO: 「変数名集合.sum」未実装

** 入力ファイルの文法
入力ファイルは、次のセクションからなる。順序は自由。ないものがあってもよい。

META		ページタイトル等を指定
GROUP		変数グループを指定
UI		UI、変数の他変数への静的・動的な寄与を指定
RELATION	等式・不等式の関係式を指定
UNLOCK		上限開放を指定
QUERY		検索ボタンを指定
SUMMARY		結果表示のsummary部分を指定
DETAILS		結果表示のdetails部分を指定

TODO: 検索結果をピンどめする
TODO: プルダウンを値で色変更
TODO: INDUCEはなくすのがよいか、残すのがよいか

*** METAセクション
| [META]		セクション開始タグ
| title タイトル	ページタイトル指定
| glpk show/hide	GLPKログを表示するかしないか
| url ライブラリのurl	glpk-all.js, worker, *lib.js のあるパスを指定
| localstorage キー	localstrageのキー指定

TODO: urlまだやってない
TODO: localstrageまだやってない
TODO: no-negative 「-inf <= 変数」を出力しないため

*** GROUPセクション
変数のグループを指定
| [GROUP]      セクション開始タグ
| {グループ名} グループ指定開始タグ。次行から所属させる変数を列挙する

TODO: 他のグループとの合併とか

*** UIセクション
防具、装飾品等の所持数や、検索するスキルのレベルを設定するUIを指定する。
装備がどのようなスキル等を発動するかも指定する。
動的なユーザー装備も指定する。

| [UI]                セクション開始タグ
| width:00px          UI部品の幅を指定 (以後継続)
| nowidth             UI部品の幅指定を解除
| subsection タイトル details要素の開始
| br               改行タグ。
| space            スペースを置く
| 文字列           文字列を表示


| (下限..上限)[*]  変数名 -> 寄与先 寄与値, 寄与先 寄与値,...

装備の個数範囲を指定する「(下限..上限)[*]」は省略可能。
変数の寄与を指定する「->」以降は省略可能。

下限、上限は次のいずれか。
| 空文字列	    制限なし。UIは生成されない。
| 数値 		    定数。UIは生成されない。
| [数値 数値 ..]    プルダウンが生成される。
| 数値?      	    テキストボックス。数値は初期値
| C 	     	    チェックボックス。チェックされていたら1


また*は、上限、下限が最大幅の場合、結果表示で列番号に1加える

寄与先は次のいずれか
| 変数名       固定の寄与先変数名
| {グループ}名 プルダウンを生成し、そこから寄与先変数名を選ぶ

寄与値は次のいずれか
| 数値	     	 固定の数値
| [数値 数値 ..] プルダウンを生成し、そこから値を選ぶ


TODO: 武器スキル
TODO: 文字列エスケープ (そもそも文字列がサポートされているか要確認)
TODO: 変数を (定数でなく) 別の変数に (プルダウンで選択して) 束縛する。
      最大化するものを可変にするのには使える。
TODO: ユーザー定義の装備 (ライズの護石対応)
TODO: [0-7] 形式
TODO: 寄与先で[変数名 {グループ名} ...] を可能にする

*** QUERYセクション
最大化検索
| [QUERY]			 			  セクション開始タグ
| ボタンテキスト 検索中止テキスト 追加検索テキスト 変数名
TODO: 最大化する式を選択できるようにしたい。 UIのTODOも参照

*** RELATIONセクション
等式や不等式の関係式を指定する。

| [RELATION]             セクション開始タグ
| 1次式 op 1次式 op ..

op は、= <= >= のいずれか。最終的には、左辺に定数項がなく、右辺が定数の
みである等式・不等式に変換して、GLPKに読ませる。

*** UNLOCKセクション
| [UNLOCK]	セクション開始タグ
| 変数名1 数値a, 変数名2 数値b 数値c

変数名2の上限は、変数名1が数値a未満なら数値b、以上なら数値c。

実態は、新しい変数 Y を導入して

変数名2 - b <= (c-b) Y
a Y <= 変数名1

の2式を生成する糖衣構文。

*** SUMMARYセクション
| [SUMMARY]     セクション開始タグ
| width:00px	UI部品の幅を指定 (以後継続)
| nowidth	UI部品の幅指定を解除
| n/v/* 変数名  summaryに結果表示する指定

nは変数名を、vはその値を。両方も可能。*は0のとき表示しない。
変数名を「{グループ名}」とすると、グループに属する変数を順に指定。

TODO: 変数名に変数名集合も使いたい

*** DETAILSセクション
| [DETAILS]        セクション開始タグ
| newcolumn 文字列 列の開始。文字列の「!」は下と同じ
| 文字列	   そのまま表示。先頭が!のときは強制で一番上に
| n/v/* 変数名 	   detailsに結果表示する指定

DETAILSセクションは列で構成され、1つの列の内容は縦方向に並ぶ。
nは変数名を、vはその値を。両方も可能。*は0のとき表示しない。
変数名を「{グループ名}」とすると、グループに属する変数を順に指定。

TODO: 文字列の色とか太字。セキュリティ
TODO: 追加発動ボタン
TODO: かかった時間
TODO: 変数名に変数名集合も使いたい

* 入力データの文法 -- 大きな変更が入るのでその前の状態で保存  (11 Apr 2021)
simgen03.rb からの文法

** 入力ファイルの基本事項
*** コメント
# で始まる行はコメント
空行は無視

*** 変数名
すべての文字を使ってよいが、以下の文字と空白は使えない。
| -+=<>()#?:"'[]

また、先頭に数字は使えない。

*** 1次式
| 数値 変数名 [+-] 数値 変数名 ...
定数項も可。

** 入力ファイルの文法
入力ファイルは、次のセクションからなる。順序は自由。ないものがあってもよい。

META		ページタイトル等を指定
UI		UIを指定
QUERY		検索ボタンを指定
RELATION	等式・不等式の関係式を指定
INDUCE		変数の他変数への寄与を元に等式の関係式を指定
UNLOCK		上限開放を指定
SUMMARY		結果表示のsummary部分を指定
DETAILS		結果表示のdetails部分を指定

TODO: 検索結果をピンどめする
TODO: プルダウンを値で色変更

*** METAセクション
| [META]		セクション開始タグ
| title タイトル	ページタイトル指定
| glpk show/hide	GLPKログを表示するかしないか
| url ライブラリのurl	glpk-all.js, worker, *lib.js のあるパスを指定
| localstorage キー	localstrageのキー指定

TODO: urlまだやってない
TODO: localstrageまだやってない
TODO: no-negative 「-inf <= 変数」を出力しないため

*** UIセクション
防具、装飾品等の所持数や、検索するスキルのレベルを設定するUIを指定する。
UI指定が必要なだけ記述される。不等式も指定したことになる。

| [UI]                セクション開始タグ
| width:00px          UI部品の幅を指定 (以後継続)
| nowidth             UI部品の幅指定を解除
| subsection タイトル details要素の開始
| br               改行タグ。
| space            スペースを置く
| 文字列           文字列を表示
| (下限..上限)[*]  変数名

下限、上限は次のいずれか。
| 空文字列	    制限なし。UIは生成されない。
| 数値 		    定数。UIは生成されない。
| [数値 数値 ..]    プルダウンが生成される。
| 数値?      	    テキストボックス。数値は初期値
| C 	     	    チェックボックス。チェックされていたら1

また*は、上限、下限が最大幅の場合、結果表示で列番号に1加える

TODO: 武器スキル
TODO: 文字列エスケープ (そもそも文字列がサポートされているか要確認)
TODO: 変数を (定数でなく) 別の変数に (プルダウンで選択して) 束縛する。
      最大化するものを可変にするのには使える。
TODO: ユーザー定義の装備 (ライズの護石対応)

*** QUERYセクション
最大化検索
| [QUERY]			 			  セクション開始タグ
| ボタンテキスト 検索中止テキスト 追加検索テキスト 変数名
TODO: 最大化する式を選択できるようにしたい。 UIのTODOも参照

*** RELATIONセクション
等式や不等式の関係式を指定する。

| [RELATION]             セクション開始タグ
| 1次式 op 1次式 op ..

op は、= <= >= のいずれか。最終的には、左辺に定数項がなく、右辺が定数の
みである等式・不等式に変換して、GLPKに読ませる。

*** INDUCEセクション
ある変数の他の変数への寄与を指定する。
寄与先の変数ごとに、1つずつ等式を生成する。

| [IDUCE]					セクション開始タグ
| 変数名 -> 変数名 数値, 変数名 数値, ...

*** UNLOCKセクション
| [UNLOCK]	セクション開始タグ
| 変数名1 数値a, 変数名2 数値b 数値c

変数名2の上限は、変数名1が数値a未満なら数値b、以上なら数値c。

実態は、新しい変数 Y を導入して

変数名2 - b <= (c-b) Y
a Y <= 変数名1

の2式を生成する糖衣構文。

*** SUMMARYセクション
| [SUMMARY]     セクション開始タグ
| width:00px	UI部品の幅を指定 (以後継続)
| nowidth	UI部品の幅指定を解除
| n/v/* 変数名  summaryに結果表示する指定

nは変数名を、vはその値を。両方も可能。*は0のとき表示しない。

*** DETAILSセクション
| [DETAILS]        セクション開始タグ
| newcolumn 文字列 列の開始。文字列の「!」は下と同じ
| 文字列	   そのまま表示。先頭が!のときは強制で一番上に
| n/v/* 変数名 	   detailsに結果表示する指定

nは変数名を、vはその値を。両方も可能。*は0のとき表示しない。DETAILSセク
ションは列で構成され、1つの列の内容は縦方向に並ぶ。

nは変数名を、vはその値を。両方も可能。*は0のとき表示しない。

TODO: 文字列の色とか太字。セキュリティ
TODO: 追加発動ボタン
TODO: かかった時間



* 入力データの文法 -- スマートでないので更新停止 -- (2 Apr 2021)
** 入力ファイルの基本事項
*** コメント
# で始まる行はコメント
空行は無視

*** 変数名
すべての文字を使ってよいが、以下の文字と空白は使えない。
| -+=<>()#?:"'[]

また、先頭に数字は使えない。

*** 1次式
| 数値 変数名 [+-] 数値 変数名 ...
定数項も可。

** 入力ファイルの文法
入力ファイルは、次のセクションからなる。順序は自由。ないものがあってもよい。

META		ページタイトル等を指定
UI		UIを指定
QUERY		検索ボタンを指定
RELATION	等式・不等式の関係式を指定
INDUCE		変数の他変数への寄与を元に等式の関係式を指定
UNLOCK		上限開放を指定
SUMMARY		結果表示のsummary部分を指定
DETAILS		結果表示のdetails部分を指定

TODO: 検索結果をピンどめする
TODO: プルダウンを値で色変更

*** METAセクション
| [META]		セクション開始タグ
| title タイトル	ページタイトル指定
| glpk show/hide	GLPKログを表示するかしないか
| url ライブラリのurl	glpk-all.js, worker, *lib.js のあるパスを指定
| localstorage キー	localstrageのキー指定

TODO: urlまだやってない
TODO: localstrageまだやってない
TODO: no-negative 「-inf <= 変数」を出力しないため

*** UIセクション
防具、装飾品等の所持数や、検索するスキルのレベルを設定するUIを指定する。
UI指定が必要なだけ記述される。不等式も指定したことになる。

| [UI]			セクション開始タグ
| [UI] width:00px	UI部品の幅を指定 (以後継続)
| [UI] nowidth		UI部品の幅指定を解除
| [UI] subsection タイトル details要素の開始
| [UI] br		改行タグ。
| [UI] space		スペースを置く
| [UI] 文字列		文字列を表示
| (下限..上限)[*] 変数名
| :

下限、上限は次のいずれか。
| 空文字列		制限なし。UIは生成されない。
| 数値			定数。UIは生成されない。
| [数値 数値 ..]	プルダウンが生成される。
| 数値?			テキストボックス。数値は初期値
| C			チェックボックス。チェックされていたら1

また*は、上限、下限が最大幅の場合、結果表示で列番号に1加える

TODO: 武器スキル
TODO: 文字列エスケープ (そもそも文字列がサポートされているか要確認)

*** QUERYセクション
最大化検索
| [QUERY]			 			  セクション開始タグ
| ボタンテキスト 検索中止テキスト 追加検索テキスト 変数名
TODO: 最大化する式を選択できるようにしたい

*** RELATIONセクション
等式や不等式の関係式を指定する。

| [RELATION]					セクション開始タグ
| 1次式 op 1次式 op ..

op は、= <= >= のいずれか。最終的には、左辺に定数項がなく、右辺が定数の
みである等式・不等式に変換して、GLPKに読ませる。

*** INDUCEセクション
ある変数の他の変数への寄与を指定する。
寄与先の変数ごとに、1つずつ等式を生成する。

| [IDUCE]					セクション開始タグ
| 変数名 -> 変数名 数値, 変数名 数値, ...

*** UNLOCKセクション
| [UNLOCK]	セクション開始タグ
| 変数名1 数値a, 変数名2 数値b 数値c

変数名2の上限は、変数名1が数値a未満なら数値b、以上なら数値c。

実態は、新しい変数 Y を導入して

変数名2 - b <= (c-b) Y
a Y <= 変数名1

の2式を生成する糖衣構文。

*** SUMMARYセクション
| [SUMMARY]		セクション開始タグ
| [SUMMARY] width:00px	UI部品の幅を指定 (以後継続)
| [SUMMARY] nowidth	UI部品の幅指定を解除

| n/v/* 変数名		summaryに結果表示する指定

nは変数名を、vはその値を。両方も可能。*は0のとき表示しない。

*** DETAILSセクション
| [DETAILS]		セクション開始タグ
| [DETAILS] newcolumn	列の開始
| [DETAILS] 文字列	そのまま表示。先頭が!のときは強制で一番上に
| n/v/* 変数名		detailsに結果表示する指定

nは変数名を、vはその値を。両方も可能。*は0のとき表示しない。DETAILSセク
ションは列で構成され、1つの列の内容は縦方向に並ぶ。

nは変数名を、vはその値を。両方も可能。*は0のとき表示しない。

TODO: 文字列の色とか太字。セキュリティ
TODO: 追加発動ボタン
TODO: かかった時間
TODO: 空きスロットのために [DETAILS] dmin 文字列 変数名1 変数名2 ... のようなものを。あるいは、ユーザー関数


* 入力データの文法 -- 複雑なので捨てた (17 Mar 2021)
** 等式、不等式とそのパラメータ設定のUIの指定
| [<結果表示指定>] [<条件>] <1次式> [-> k1 変数a1, k2 変数a2, ...]

<1次式>のki倍を、別に生成される条件 「変数ai = 」の右辺に追加し、
<条件>に基づいて等式、不等式を生成し、
<条件>に基づいてUIを生成し、
<結果表示指定>に基づいて結果に表示する。

末尾のカンマは省略可能。
<結果表示指定> と <条件> と -> 以降をすべて省略した場合はエラー。

<1次式>は、
| l1 変数b1 [+-] l2 変数b2 ...

<結果表示指定> は、
| S<番号>		summaryに<番号>順に表示。0の時表示しない。
| S*<番号>		summaryに<番号>順に表示。常に表示する
| D<列番号>-<番号>	detailsの第<列番号>列に<番号>順に表示。0の時表示しない
| D*<列番号>-<番号>	detailsの第<列番号>列に<番号>順に表示。常に表示する

D<列番号>-<番号> で、無指定だった場合は、第(<列番号>+1)列に表示
D<列番号>-<番号> は、「追加発動」検索の対象

<条件>は、
| ([<数値集合1>]..[<数値集合2>])

両方指定されたら、a <= 1次式 <= b
一方なら、a <= 1次式 か 1次式 <= b
両方省略されたらエラー。
TODO: チェックボックスも追加したい

<数値集合>は、次のいずれか
| <数値>			その数値の即値
| [<数値1> <数値2> ...]		プルダウンを生成し、選択された数値
| ?				入力ボックス

<数値>が「*」だと無指定を意味し、等式、不等式を生成しない
TODO: 1-7 の表現もサポートしたい

** 検索ボタンの指定
| (query) <ボタンテキスト> <検索中止テキスト> <追加検索テキスト> <1次式>

最大化検索
TODO: 最大化する式を選択できるようにしたい

** 結果表示の指定
| (result) <1次式> <detail第1列見出し>  <detail第2列見出し> ...

<1次式>はsummary先頭への表示
さらに最後の列の次には、「追加発動」列が加わる

** その他
「#」で始まる行は、コメント
「<」で始まる行は、そのままhtmlに出力。ヘッダや<h3>等はこれで指定
TODO: UI部品や入力ボックスの幅を指定できるようにしたい
