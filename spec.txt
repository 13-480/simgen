-*- mode: outline; fill-column: 70; coding: utf-8 -*-
* 入力データの文法 (9 May 2021)
simgen.rb に読ませる入力ファイルの仕様メモ

** コメント
# で始まる行はコメント
空行は無視

** 基本的な文法要素
*** 変数名
すべての文字を使ってよいが、先頭に数字は使えず、以下の文字と空白は使えない。
| -+=<>()%#?:"'[]{},

変数名を要求される所ではどこでも、「変数名:{グループ名}」のように、グ
ループへの登録指定も行える。

*** グループ名
グループ名に使える文字はは変数名と同じで、さらに、それをブレースで囲む。

*** 変数名集合
| グループ名
| [変数名orグループ名 ...]
ブラケットに入っている場合でもグループ名はブレースで囲む。

*** 1次式
| 数値 変数名 [+-] 数値 変数名 ...
定数項も可。
変数名の所では、「{グループ名}.sum」や、「変数名集合.sum」も可能。

** 入力ファイルの文法
入力ファイルは、次のセクションからなる。順序は自由。ないものがあってもよい。
ただし、QUERYセクションがない場合などはエラーとなる。

セクション名	内容
META		ページタイトル等を指定
GROUP		変数グループを定義
UI		UI、変数の他変数への静的・動的な寄与を指定
RELATION	等式・不等式の関係式を指定
UNLOCK		上限開放を指定
QUERY		検索ボタンを指定
SUMMARY		結果表示のsummary部分を指定
DETAILS		結果表示のdetails部分を指定

TODO: 検索結果をピンどめする機能

*** METAセクション
| <META>		セクション開始タグ
| title タイトル		ページタイトル指定
| glpk show/hide	GLPKログを表示するかしないか
| url ライブラリのurl	glpk-all.js, worker, *lib.js のあるパスを指定
| localstorage キー	localstrageのキー指定

TODO: urlまだやってない。ローカルのパスを書かせては危険な模様
TODO: localstorageをJSON.stringifyしてコピペできるように。

*** GROUPセクション
変数のグループを指定
| <GROUP>     セクション開始タグ
| {グループ名} グループ指定開始タグ。次行から所属させる変数を列挙する

*** UIセクション
防具、装飾品、護石、スキル等の変数に対して、値のとりうる範囲や、どの装
備がどのスキルを発動するか等を静的・動的に設定する。

「動的」とは、値の範囲やどのスキルを発動するかを、検索時にページ上でユー
ザがプルダウン等で指定できることを指し、「静的」とは、値の範囲等が定数
で与えられ、ユーザが変更できないことを指す。

**** 体裁等に関するもの

| <UI>               セクション開始タグ
| width:00px         UI部品の幅を指定 (以後継続)
| nowidth            UI部品の幅指定を解除
| subsection タイトル details要素の開始
| br                 改行タグ。
| space              スペースを置く。幅指定がある場合にのみ意味がある。
| 文字列              文字列を表示

**** 値の範囲やスキルの発動に関するもの

| (下限..上限)[*]  変数名 -> 寄与先 寄与値, 寄与先 寄与値,...

装備の個数範囲を指定する「(下限..上限)[*]」は省略可能。
変数の寄与を指定する「->」以降は省略可能。

下限、上限、寄与値は次のいずれか。
| 空文字列       制限なし。UIは生成されない。
| 数値 		定数。UIは生成されない。
| [数値 数値 ..] プルダウンが生成される。
| 数値?      	テキストボックス。数値は初期値
| C 		チェックボックス。チェックされていたら1

また*は、上限、下限が動的に設定される場合に、最大幅になるよう設定され
ている場合、DETAILSセクションでの結果表示で次の列に表示させる指定。

寄与先は次のいずれか
| 変数名       固定の寄与先変数名
| {グループ名} プルダウンを生成し、そこから寄与先変数名を選ぶ
| 変数名集合   プルダウンを生成し、そこから寄与先変数名を選ぶ

TODO: 文字列エスケープ (そもそも文字列がサポートされているか要確認)
TODO: 数値のプルダウンでの[0-7] 形式

**** インポートに関するもの
| import	装備データのインポート

テキストボックスが表示され、そこへ装備データを書けば、検索時に解釈、利
用される。所持数は1に固定。文法は、スペース、タブ、または、カンマ区切りで、

| 装備名 グループ名 発動1 値1 発動2 値2 ...

TODO: 未実装

*** RELATIONセクション
等式や不等式の関係式を指定する。

| <RELATION>             セクション開始タグ
| 1次式 op 1次式 op ..

op は、= <= >= のいずれか。

*** UNLOCKセクション
上限解放の指定。
| <UNLOCK>	                  セクション開始タグ
| 変数名1 数値a, 変数名2 数値b 数値c

変数名2の上限は、変数名1が数値a未満なら数値b、以上なら数値c。
実態は、新しい変数 Y を導入して、次の2式を生成する糖衣構文。

変数名2 - b <= (c-b) Y
a Y <= 変数名1

*** QUERYセクション
指定した変数を最大化する検索を実行するボタンの指定。
複数のボタンを置くことはできない。
| <QUERY>			 			  セクション開始タグ
| query ボタンテキスト 検索中止テキスト 追加検索テキスト 変数名

*** SUMMARYセクション
| <SUMMARY>     セクション開始タグ
| width:00px	UI部品の幅を指定 (以後継続)
| nowidth	UI部品の幅指定を解除
| n/v/* 変数名   summaryに結果表示する指定

nは変数名を、vはその値を表示する。両方も可能。*は0のとき表示しない。
変数名を「{グループ名}」とすると、グループに属する変数を順に指定。

*** DETAILSセクション
| <DETAILS>        		セクション開始タグ
| newcolumn 文字列  		列の開始。文字列の「!」は下と同じ
| time		   		所要時間
| more ボタンテキスト グループ名	追加スキル検索ボタン
| 文字列 	      		そのまま表示。先頭が!のときは強制で一番上に
| n/v/* 変数名 	   		detailsに結果表示する指定

DETAILSセクションはいくつかの列で構成され、1つの列の内容は縦方向に並ぶ。

nは変数名を、vはその値を表示する。両方も可能。*は0のとき表示しない。
変数名を「{グループ名}」とすると、グループに属する変数を順に指定。
また変数名にUIセクションでの範囲指定に「*」が付いていた場合、その動的
な範囲指定が最大幅になる指定であれば、当該の列ではなく、次の列に表示する。

TODO: 文字列のセキュリティ
TODO: スキルの値によりソート
